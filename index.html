<<!DOCTYPE html>
<html lang='en'>
<head>
	<base href="index.html" target="_blank">
	<meta charset=utf-8 />
	<title id="title">SiebelcoSites</title>
	<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no' />

<!-- Make sure you put this AFTER Leaflet's CSS -->
<!-- /
*****************************************************
***************** The ****************~~~~~~~~~~*****
************** Sibelco **************| ` .`  - |*****
************ Corperation ****************************
*************** may *********************************
************** pollute ******************************
**************** the ********************************
**************** north ******************************
**************** toe ********************************
*************** River *******************************
*********!!!! WaterLevelMedium Investigates!!! ******
*****************************************************
*****************************************************

-->
<!-- Nice background-color from sonny rollins website : #3c3b4a -->
<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!! START DEPRECIATED CDN LINKS !!!!!!!!!!!!!!!!!!!!!!! -->
<!-- REMOVED minimal jquery <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.slim.js" integrity="sha512-M3zrhxXOYQaeBJYLBv7DsKg2BWwSubf6htVyjSkjc9kPqx7Se98+q1oYyBJn2JZXzMaZvUkB8QzKAmeVfzj9ug==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
<!-- <script src="http://code.jquery.com/jquery-3.1.1.min.js"></script> -->
<!-- Old bootstrap, depreciated -->
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script> -->
<!-- old  Jquery / dup leaflet / old chroma
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>   OLD CDN-->

<!-- OLD JQUERY <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>      <!-- updated 10/13/2022 --> -->
<!-- REMOVED MINIMAL JQUERY <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script> -->
<!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
	integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
	crossorigin=""></script> -->

<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!! END DEPRECIATED CDN LINKS !!!!!!!!!!!!!!!!!!!!!!! -->

<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!! START ACTIVE CDN LINKS !!!!!!!!!!!!!!!!!!!!!!! -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.14.0/css/all.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.css" />
<link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Lora" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js" integrity="sha512-zInFF17qBFVvvvFpIfeBzo7Tj7+rQxLeTJDmbxjBz5/zIr89YVbTNelNhdTT+/DCrxoVzBeUPVFJsczKbB7sew==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css" integrity="sha512-mD70nAW2ThLsWH0zif8JPbfraZ8hbCtjQ+5RU1m4+ztZq6/MymyZeB55pWsi4YAX+73yvcaJyk61mzfYMvtm9w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js" integrity="sha512-Dqm3h1Y4qiHUjbhxTuBGQsza0Tfppn53SHlu/uj1f+RT+xfShfe7r6czRf5r2NmllO2aKx+tYJgoxboOkn1Scg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- Leaflet Ajax must be below Leaflet source cdn  -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>


<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!! END ACTIVE CDN LINKS !!!!!!!!!!!!!!!!!!!!!!! -->

<style>

  head {
    height: 0;
  }
	html {
		box-sizing: border-box;
    margin: 0px;
    padding 0;
    width: 100%;
    line-height:0;

	}
		body {
			margin: 0;
			padding: 0;
			background: #3c3b4a;
			font-family: "Noto Sans", sans-serif;
			color: #3d3d3d;
      line-height: 0;
		}

		#map {
			display: flex;
			/* //top: 0; */
			bottom: 0px;
			width: 100%;
      height: 100%;
      z-index: 900;
		}
		#showPoints {
			right: 8px;
		}
		#tables {
			right: 100px;

    }


    .navBar {

    }
		#tablesCollapse {
			z-index: 900;
		}
    /* .dropdown {
      padding:2px,
      float: right;
    } */

</style>
</head>

<body>
<!-- start nav bar REMOVED 0.0.2 -->
<!-- Remember working in Bootstrap 4 not 5  -->
<!-- <span class="border border-primary"></span>

<nav id="navBar" class="navbar navbar-dark" style="background-color: #010B13">
		<a class="navbar-brand mg-sm-1" href="#" style="text-align:right">Is Siebelco North America an enviornmental hazard?</a>
			<div class='btn-group' role='group' aria-label='options'>
        <div class='dropdown'>
        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Sibelco SchoolHouse Layers
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          <button  class="btn btn-primary btn-sm" type="button" onclick="toggleLayer(SchoolHouseSSURGO)">SSURGO DB</button>
          <a class="dropdown-item" href="#">Another action</a>
          <button  class="btn btn-primary btn-sm" type="button" onclick="updateTable()">Impervious Surfaces</button>
        </div>
      </div>

      <!-- Peristent Buttons, i.e., NOT in dropdown menu constant visibility -->
        <!-- <button  class="btn btn-primary btn-sm" type="button" onclick="floodFreq_Cr()">DEVSAVEPERSISTENTPOINTS</button>
				<button  class="btn btn-primary btn-sm" type="button" data-toggle="collapse" data-target="#cameraCollapse" aria-expanded="false" aria-controls="cameraCollapse">Show points</button>
        <button class="btn btn-primary btn-sm" type="button" onclick="downloadData()">Download CSV</button>
				<button class='btn btn-danger btn-sm' type='button' onclick='sessionStorage.clear()'>Clear Session </button>

        <!-- Start Sieblco Crystal Drive Facility Dropdown -->
        <!-- <div class='dropdown'>
        <button class="btn btn-secondary dropdown-toggle" type="button" id="crystalDropdownButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Sibelco Crystal Dr. Layers
        </button>
        <div class="dropdown-menu" aria-labelledby="crystalDropdownButton">
          <a class="dropdown-item" href="#">Flood Frequency Overlay</a>
          <a class="dropdown-item" href="#">Another action</a>
          <a class="dropdown-item" href="#">Something else here</a>
        </div>
      </div>
  </div>
</nav> -->

<nav class="navbar navbar-dark sticky-top " style="background-color: #1c66a6 ">
  <div class="container-fluid">
    <div class="align-self-xxl-end">
      <a class="navbar-brand" href="#">Sibelco N.A. Environmental Assesment</a>
        <span class="navbar-text">Spruce Pine, NC</span>
    </div>

        <button class="navbar-toggler ml-auto" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
          <span class="navbar-text">Layer Options</span>
          <span class="navbar-toggler-icon"></span>
        </button>

<style media="screen">
	.offcanvas-body {
		background: #9d8625;
	}
	.offcanvas-header {
		background: #9d8625;
	}
</style>

<!-- START SIDEBAR !!!!!!!!!! HIDDEN IN OPEN PAGE -->
	<div class="wholeOffcanvas">
    <div class="offcanvas offcanvas-bottom text-bg-dark" data-bs-scroll="true"  tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Sibelco Facilities</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
<!-- encapsulates everything EXCEPT the search bar-->
          <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
              <li class="nav-item">
                <!-- <a class="nav-link active" aria-current="page" href="/schoolHouse.html"> SchoolHouse - <i> Harris Mining Company Rd. </i></a> -->
<!-- https://www.sibelco.com/sites/schoolhouse SITE WEBPAGE-->
              </li>
<!-- DEFAULT CHECKBOX W LABEL  <li>  <input class="form-check-input mt-0" id="checkbox" checked type="checkbox" value="" onchange="toggleLayer(Crystal_SSURGO_FloodFreq)" aria-label="Checkbox for following text input">
<label class="form-check-label" for="checkbox"> Flood Frequency - <i>Dominant Condition </i></li> -->

<!-- !!!!!!!!!!PRIMARY DropDown Start !!!!!!!!!! -->
							<li class="nav-item dropdown">
								<a class="nav-link dropdown-toggle" href="#" onClick='goToLayer(primary_SSURGO_WGS84_floodFreqMax)'role="button" data-bs-toggle="dropdown" aria-expanded="false"> Primary Spruce Pine Facility  </a>
									<ul class="dropdown-menu">
										<li>  <input class="form-check-input mt-0"  id="primary_floodfreq_checkbox"  type="checkbox" value="" onchange="toggleLayer(primary_SSURGO_WGS84_floodFreqMax)" aria-label="Checkbox for following text input" checked/>
											<label class="form-check-label" for="primary_floodfreq_checkbox"> Flood Frequency - <i>Max Condition </i></li>

												<hr class="dropdown-divider">
											<!-- !!!!!!!!!!	START NEW DROPDOWN ITEM HERE !!!!!!!!!! -->



										</ul>
								</li>
<!-- !!!!!!!!!!PRIMARY DropDown END !!!!!!!!!! -->
<hr class="nav-divider">
<!-- !!!!!!!!!!SCHOOLHOUSE DropDown Start !!!!!!!!!! -->
							<li class="nav-item dropdown">
								<a class="nav-link dropdown-toggle" href="#" onClick="goToLayer(SchoolHouse_SSURGO_FloodFreq)" role="button" data-bs-toggle="dropdown" aria-expanded="false"> SchoolHouse - <i> Harris Mining Company Rd. </i>  </a>
									<ul class="dropdown-menu">
										<li>  <input class="form-check-input mt-0" id="schoolhouse_floodfreq_checkbox" type="checkbox" value="" onchange="toggleLayer(SchoolHouse_SSURGO_FloodFreq)" aria-label="Checkbox for following text input" checked/>
											<label class="form-check-label" for="schoolhouse_floodfreq_checkbox"> Flood Frequency - <i>Dominant Condition </i></li>

											<hr class="dropdown-divider">
									<!-- !!!!!!!!!!	START NEW DROPDOWN ITEM HERE !!!!!!!!!! -->

					</ul>
								</li>
<!-- !!!!!!!!!!SCHOOLHOUSE DropDown END !!!!!!!!!! -->

        			<hr class="nav-divider">

<!-- !!!!!!!!!!CRYSTAL DropDown Start !!!!!!!!!! -->

              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" onClick='goToLayer(Crystal_SSURGO_FloodFreq)' role="button" data-bs-toggle="dropdown" aria-expanded="false"> 136 Crystal Dr.  </a>
                  <ul class="dropdown-menu">

											<li>  <input class="form-check-input mt-0" id="crystal_floodfreq_checkbox" checked type="checkbox" value="" onchange="toggleLayer(Crystal_SSURGO_FloodFreq)" aria-label="Checkbox for following text input">
												<label class="form-check-label" for="crystal_floodfreq_checkbox"> Flood Frequency - <i>Dominant Condition </i></li>
													</li>
                      <hr class="dropdown-divider">

										<!-- !!!!!!!!!!	START NEW DROPDOWN ITEM HERE !!!!!!!!!! -->

                    </ul>
                </li>
<!-- !!!!!!!!!!CRYSTAL DropDown END !!!!!!!!!! -->

					<hr class="nav-divider">
            </ul>
            <!-- removed 2023-02-03 <form class="d-flex mt-3" role="search">
              <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
              <button class="btn btn-outline-success" type="submit">Search</button>
            </form> -->
        </div>
      </div>
    </div>
	</div>
<!-- !!!!!!!!!!!!!!!!!! END OFF CANVAS BODY // END HIDDEN SIDEBAR -->

</nav>
<!-- end nav bar, includes title and buttons -->
<!-- start table header -->
	<div class="tablesCollapse">
	<div class="row">
		<div class="col">
			<div class="collapse multi-collpase" id="cameraCollapse">
				<div class="card card-body">
					<div class="row">
						<div class="col-sm">
							<b> Name </b>
						</div>
						<div class="col-sm">
						<b>	Latitude, Longitude </b>

						</div>
						<div class="col-sm">
						<b>	Description </b>
						</div>
					</div>
<!-- end table header -->
<!-- Start session points in drop down table -->
					<div id='insertTheText'> </div>
		</div>
		</div>
	</div>
</div>
</div>


<div id='map'></div>



<script id="mainScript">


//!!!!!!!!!!!!!!!!!!!!!!!!!!!! SETUP !!!!!!!!!!!!!!!!!!!!!!!!!!!!

var options = {
	center: [35.923124, -82.078514],
	zoom: 12,
	closePopupOnClick: true,
};
	const dropTables = [];
	const pointsTable = [];
	const csvTables = [];
	csvTables.push(' ,Name,Lat,Lng,Description\n'); //extra commma before name because it aligns to the bad output
	var map = L.map('map', options);

// Esri Basemap has more zoom
var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
}).addTo(map);
// var USGS_USImageryTopo = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryTopo/MapServer/tile/{z}/{y}/{x}', {
// 	maxZoom: 20,
// 	attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>'
// }).addTo(map);
map.createPane('CountyBoundaries');





/*
COLOR PALLET
1c66a6 - top banner , e39959 - inverted , cd071e - chinese red, bcd4e6 - beau blue , ffff99 - canary yellow , 9d8625 - compliment banner
*/
const crossIcon = L.divIcon({
	html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="#FF0000" d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>',
	iconSize: [30, 30],
	className: 'pendingMarker',
});
const xIconBlue = L.divIcon({
html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path weight: 2px fill-opacity=".8" fill="#0000FF" d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z"/></svg>',
iconSize: [15, 12] ,
className: 'xIconBlue',
});

const xIconCanary = L.divIcon({
html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path weight: 2px fill-opacity=".8" fill="#ffff99" d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z"/></svg>',
iconSize: [15, 12] ,
className: 'xIconBlue',
});




//!!!!!!!!!!!!!!!!!!!!HELPER FUNCTIONS!!!!!!!!!!!!!!!!!!!!!!!

function goToLayer(layer){
	map.setZoom(15);
	try {
			map.flyTo(layer.getLatLng());
		} catch {
			map.flyToBounds(layer.getBounds());
		}
};
// CHROMA COLOR SCALES
// make color scale
 var whiteToBlue = chroma.scale(['white','blue']).colors(5);
 var correctedReds = chroma.scale(['black','red','yellow','white']);
 // .correctLightness();

 // primary ssurgo data  has a different flodfreqcd vs flodfreqdcd proprty
 // also has fewer flood areas.
 function primary_FloodFreqScale(val){
	 if(val == 'Frequent'){return '#0000ff'}
	 else if(val=='None'){return 'rgba(1,1,1,0)'};
 };
 function primary_FloodFreqStyle(feature){
			 return {
				 fillColor: primary_FloodFreqScale(feature.properties.flodfreqma),
				 fillOpacity: 1,
				 color: 'rgba(1,1,1,0)',
			 }
	 };
 // set corresponding properties values for the flodfreqcd value of the SSURGO lAYERS
function floodFreqColorScale(val){
           var id = 0;
           if (val == 'Rare'){id = 2}
           else if(val == 'Frequent'){id =4}
           else if(val == 'Occasional'){id = 3}
           else if(val == 'None'){id = 1}
           return whiteToBlue[id];
        };
// white to blue scale for rated flood frequency by soil grouping
function floodFreq_style(feature){
     return {
           fillColor: floodFreqColorScale(feature.properties.flodfreqdcd),
            fillOpacity: 0.3,
            weight: 2,
            opacity: .3,
            color: '#b4b4b4',
            dashArray: '2'
   };
  };

// above styling corresponds to SSURGO soils data, yanking the flood frequency in a gradient around the site.


// !!!!!!!!!!!!!!!!!!!! BASE LAYERS !!!!!!!!!!!!!!!!!!!!

var ncCountyShape = new L.GeoJSON.AJAX('assets/NCDOT_County_Boundaries_Spat.geojson',{
           attribution: 'Map: River Pyle,</br> Layers: <a href="https://www.nconemap.gov/datasets/9728285994804c8b9f20ce58bae45899_0/explore?location=35.119934%2C-79.919073%2C7.27"> NC OneMap County Boundaries</a> <a href="https://data-ncdenr.opendata.arcgis.com/datasets/nc-mining-permits/about">|  NCDEQ Mining Permits </a>',
           pane: 'CountyBoundaries',
           fillOpacity: 0.001,
           opacity: 1,
           color: '#000000',
         }).addTo(map);



// !!!!!!!!!!!!!!!!!!!!!!!!!!!START SEBILCO PRIMARY lAYER!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
// doesnt exist rn
// var WQ_Points_Primary = new L.GeoJSON.AJAX('assets/WQ_Points.geojson',{
//   onEachFeature: function popUp(f,l){
//        var out = [];
//        if (f.properties){
//            for(key in f.properties){
//                out.push(key+": "+f.properties[key]);
//            }
//            l.bindPopup(out.join("<br />"));
//        }
//    }, //
//   pointToLayer: function(feature, latlng){
//     return L.marker(latlng,{icon: xIconBlue, color: 'red'});
//   },
// }).addTo(map);



 var primaryFacility = L.marker([35.936842, -82.097198], {icon: crossIcon}).addTo(map);
 var primaryPopupText = `
     <div class="col-sm"><a href="https://www.sibelco.com/sites/crystal">Sebilco </br> North America </a></div>
		<div class="col-sm"> <a href="` + googMapsLink(primaryFacility.getLatLng())  + `">35.89775, -82.06115</a></div>

 `;
 primaryFacility.bindPopup(primaryPopupText).addTo(map);


// for whatever reason the main facility SSURGO outline exported
// to geojson still in UTM NC Zone 17 or whatevrer
 var primary_SSURGO_WGS84_floodFreqMax = new L.GeoJSON.AJAX('assets/primary_SSURGO_WGS84.geojson',{
	 onEachFeature: function popUp(feature, layer){
			 // show polygon group type
			 layer.bindTooltip(feature.properties.muname)
				 // popup with whole ssurgo table
				var out = [];
				if (feature.properties){
						for(key in feature.properties){
								out.push(key+": "+feature.properties[key]);
						}
						layer.bindPopup(out.join("<br />"),{autoPan: false});
				};

		},
	 fillOpacity: 0.2,
	 opacity: .2,
	 dashArray:'4',
	 style: primary_FloodFreqStyle,

 }).addTo(map);


// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!! END SIBELCO PRIMARY LAYERS !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!



// !!!!!!!!!!!!!!!!!!!! START CRYSTAL DR LAYERS !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

var CrystalDrive = L.marker([35.89775,-82.06115], {icon: crossIcon}).addTo(map);
var crystalPopupText = `
  <div class="row">
    <div class="col-sm">CrystalDrive Facility</div>
    <div class="col-sm">35.89775, -82.06115</div>
    <div class="col-sm"><a href="https://www.sibelco.com/sites/crystal">Site Company <br> Webpage</a></div>
    <div class="col-sm"><a href="` + googMapsLink(CrystalDrive.getLatLng())  + `">Google Maps</a></div>

  </div>
`;
CrystalDrive.bindPopup(crystalPopupText).addTo(map);
// CrystalDrive.on('click', map.flyTo(CrystalDrive.getLatLng()));




// monitoring wells in historical ea
var crystal_MW_Points = new L.GeoJSON.AJAX('assets/Crystal_MW.geojson',{
  onEachFeature: function popUp(f,l){
       var out = [];
       if (f.properties){
           for(key in f.properties){
               out.push(key+": "+f.properties[key]);
           }
           l.bindPopup(out.join("<br />"));
       }
   }, //
  pointToLayer: function(feature, latlng){
    return L.marker(latlng,{icon: xIconBlue, color: 'green'});
  },
}).addTo(map);


var Crystal_SSURGO_FloodFreq = new L.GeoJSON.AJAX('assets/Crystal_SSURGO.geojson',{
	onEachFeature: function popUp(feature, layer){
      // show polygon group type
      layer.bindTooltip(feature.properties.muname)
        // popup with whole ssurgo table
       var out = [];
       if (feature.properties){
           for(key in feature.properties){
               out.push(key+": "+feature.properties[key]);
           }
           layer.bindPopup(out.join("<br />"),{autoPan: false});
       };

   },
  fillOpacity: 0.2,
  opacity: .2,
  dashArray:'4',
  color: 'red',
  style: floodFreq_style,
}).addTo(map);




//!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! END SIBELCO CRYSTAL DR LAYERS !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!





// !!!!!!!!!!!!!!!!!!!!!!!SCHOOLHOUSE lAYERS!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
var SibelcoSchoolhouse = L.marker([35.94604,-82.00083], {icon: crossIcon}).addTo(map);
let schoolhouseTooltipText =  `
  <div class="row align-items-start">
    <div class="col-sm">Schoolhouse Facility</div>
    <div class="col-sm">35.94604, -82.00083</div>
    <div class="col-sm"><a href="https://www.sibelco.com/sites/schoolhouse">Company Webpage</a></div>
    <div class="col-sm"><a href="` + googMapsLink(SibelcoSchoolhouse.getLatLng())  + `">Google Maps</a></div>
  </div>`;
SibelcoSchoolhouse.bindPopup(schoolhouseTooltipText,{direction: 'center'}).addTo(map);
// SibelcoSchoolhouse.on('click', map.flyTo(SibelcoSchoolhouse.getLatLng()));




var SchoolHouse_SSURGO_FloodFreq = new L.GeoJSON.AJAX('assets/SibelcoSchoolhouse_SSURGO.geojson', {
  onEachFeature: function popUp(feature, layer){
      // show polygon group type
      layer.bindTooltip(feature.properties.muname)
        // popup with whole ssurgo table
       var out = [];
       if (feature.properties){
           for(key in feature.properties){
               out.push(key+": "+feature.properties[key]);
           }
           layer.bindPopup(out.join("<br />"),{autoPan: false});
       }

   }, //
  fillOpacity: 0.2,
  opacity: .2,
  dashArray:'4',
  color: 'red',
  style: floodFreq_style,
}).addTo(map);





// !!!!!!!!!!!!!!!!!! BEHAVIOR FUNCTIONS !!!!!!!!!!!!!!!!!!!!!!!!!!

// google maps link from lat lng !! Still adds a paraenthethese on the end but its fine
function googMapsLink(latlng){
  return "https://www.google.com/maps/place/" + latlng.toString().slice(7)
};


// toggle variable to use in togglePoints(); // CREDIT: Mapsam from  https://gist.github.com/mapsam/e66a8d12c23e4bedd0ed
window.toggle = false;
// Manual toggle layer function. only layer.toggle() and layer.togglePopup() and tooltip are leaflet supported
function toggleLayer(layer){
  if(!toggle){
    map.removeLayer(layer);
  } else {
    map.addLayer(layer)
  }
  toggle = !toggle;
};






// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
// !!!!!!!!!!!!!!!!!!!!!!!!!!!START SEC CAM POINTS ADDITION FUNCTION!!!!!!!!!!!!!!!!!!!!!!!!!!!
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
// !!!!!!!!!!This isn't really needed for the Sibelco EA but I like it!!!!!!!!!!!!!!!!!!!!!!!!!
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

// csv download
function downloadData() {

	 console.log(csvTables);
	 var hidden = document.createElement('a');
	 hidden.href = 'data:text/csv;charset=utf-8,' + encodeURI(csvTables);
	 hidden.target = '_blank';
	 hidden.download = 'cameras.csv';
	 hidden.click();
};



// START User Input popup handling
// starts whenever the user presses enter
function enterPoint(lat , lng){

	let nameInput = document.getElementById('camName').value;
	let userDesc = document.getElementById('userDesc').value;

	// NOT void condition
	if (nameInput !== ''){

		//create the drop down table format to view in picture ; 1/14/2023; changing behavior of csv downlaod and page format
		var dropTable = '<div class="row"><div class="col-sm">' + nameInput + '</div>' + '<div class="col-sm">' + lat + ', ' + lng + '</div><div class="col-sm">'+ userDesc + '</div></div>';
		document.getElementById('insertTheText').innerHTML += dropTable;

		// update download link
		csvTables.push(nameInput +  ',' + lat + ',' + lng + ',' + userDesc + '\n');

		// create tooltip addition format. !How do i save to index.html?!
		var devAdd = 'var ' + nameInput.replace(' ','') + ' = L.marker(['+lat+','+lng+'], {icon: cameraIcon}).addTo(map);'
		var devAddToolTip = nameInput.replace(' ' , '') + ".bindTooltip('" + dropTable + "').addTo(map);";
		// document.getElementById('extraScript').innerHTML += devAdd;
		// document.getElementById('extraScript').innerHTML += devAddToolTip;
		document.getElementById('extraScript').insertAdjacentHTML('beforeend',devAdd);
		document.getElementById('extraScript').insertAdjacentHTML('beforeend',devAddToolTip);
		// inserAdjacentHTML resolve htmlscriptobject issues and doesnt need a toString()
		console.log("Trying to get sessionStorage to work...");
		sessionStorage.setItem(nameInput,devAdd); // adds point to sessionStorage
		sessionStorage.setItem(nameInput + "_Tooltip", devAddToolTip);

		let data = sessionStorage.getItem("key");
		console.log(data);

		// rework
		console.log('Raw Marker Vars START <--');
		console.log(devAdd);
		console.log(devAddToolTip);
		console.log('-->')

		//cleanup
		map.closePopup();
		map.setZoom(15);
	} else if (nameInput === ""){ // IS void name/desc entry, autofill ordered numeric
		//blank nanme condition
		let nameInput = "Undefined";
		let text = '|Name: Undefined \t|Coordinates:\t' + lat +', ' +  lng + '|\n\n';
		var table = '<tr><td>Undefined</td><td>' + lat + ', ' + lng + '</td><td><i opacity=".8">Description</i></td></tr>';

		//dropTable is used, add new Points to table
		var dropTable = '<div class="row"><div class="col-sm"><i opacity=".8">Undefined</i></div>' + '<div class="col-sm">' + lat + ', ' + lng + '</div><div class="col-sm"><i opacity=".8">Description</i></div></div>';
		document.getElementById('insertTheText').innerHTML += dropTable;

		//download handling
		csvTables.push('undefined,' + lat + ',' + lng + ',' + 'description' + '\n');
		var devAdd = 'var ' + nameInput + ' = L.marker(['+lat+','+lng+'], {icon: cameraIcon}).addTo(map);'
		var devAddToolTip = nameInput + '.bindTooltip("'  + dropTable  + '");';
		// document.getElementById('extraScript').innerHTML += devAdd;
		// document.getElementById('extraScript').innerHTML += devAddToolTip;
		document.getElementById('extraScript').insertAdjacentHTML('beforeend',devAdd);
		document.getElementById('extraScript').insertAdjacentHTML('beforeend',devAddToolTip);
		sessionStorage.setItem("UndefinedMarker",devAdd);
		let data = sessionStorage.getItem("sessionStorageMarker");
		console.log(data);
		console.log(devAdd.toString);
		console.log(devAddToolTip);
		map.closePopup();
		map.setZoom(15);
	};
	//remove temp tempMarker 2.2 seconds after user presses Enter
	//need to replace with camera icon and details
	var m = 2200;
	setTimeout(function(){
		pendingMarker.unbindPopup();
		map.removeLayer(pendingMarker);
			},m);

	console.log('InputPopupClosed');

};
// end user input popup

// double click event handling; creates the popup, gets the coords, makes the marker
function onDoubleClick(e){
	console.log('DoubleClick Detected!');
	// map.removeLayer(pendingMarker);
	var coordinateString = e.latlng.toString().replace('LatLng(','').replace(')','' );
	// '</br></br>Add point feature? </br></br> <button id="yes" onClick="addCircle()">Yes</button> &nbsp <button onClick="map.closePopup()">No</button></br></br><textarea id="name">  </textarea>'
	var lat = e.latlng.lat.toFixed(5) ;
	var lng = e.latlng.lng.toFixed(5) ;
	var coordinates = lat.toString + lng.toString;
	// console.log(lat + lng);
	//create dblClck marker
	let inputPopup = new L.popup()
				.setLatLng(e.latlng)
				.setContent('<input padding="10px", type="text" id="camName" placeholder="Name"></input>&nbsp&nbsp&nbsp&nbsp&nbsp<button id="enter", onClick="enterPoint(' + lat + ',' + lng + ')">Enter</button><br>' + 'Lat/Lng:&nbsp&nbsp&nbsp' +  coordinateString + '<br><input padding="10px", type="text" id="userDesc" placeholder="Description"></input>')
				.addTo(map);

	pendingMarker = new L.marker([e.latlng.lat,e.latlng.lng],{icon: crossIcon})
		.bindPopup(inputPopup)
		.addTo(map);

	// removes temp marker when new one is opened or the popup closes
	// !! didn't work with timeout, first addition would stay persistent with the input popup
	console.log(inputPopup.isPopupOpen());
	map.on('popupclose', function(){
			map.removeLayer(pendingMarker)
		});


};




// assigned to button 1/28/2023 >> assigned to sessionRefreshLoad 1.0.3
function updateMarkers(){
	let keys = Object.keys(sessionStorage);
	var extraScript = document.getElementById('extraScript'); // trying to access the main script tags to avoid undefined error
	for(let key of keys) {
		let tM = `${key}: ${sessionStorage.getItem(key)}`;
		let value = tM.split(':')[1];

		extraScript.append(sessionStorage.getItem(key)); // working
		console.log(sessionStorage.getItem(key)); // each key is tooltip script

		// document.getElementById('mainScript').insertAdjacentElement('beforeend', sessionStorage.getItem(key));
	}; //END FOR LOOP

};

function updateTable(){
	// access dropDownTable > insertHeader > insert Name > insert Lat,lng > insert description
	let keys = Object.keys(sessionStorage);
	for(let key of keys) {
		let tM = `${key}: ${sessionStorage.getItem(key)}`;
		let name = tM.split(':')[0];
		if(name.includes('Tooltip') == true){
			// console.log(tM.split("'")[1]);
			document.getElementById('insertTheText').innerHTML += tM.split("'")[1];
				};
			};
			updateMarkers();
};
var m = 1000;
setTimeout(updateTable, m);
// LOAD PERSISTENT POINTS ON REFRESH




// PRIMARY CLICK HANDLER
map.on('dblclick',  onDoubleClick);
// disbaled as it interferes with popup behavrior for point layers

map.getPane('CountyBoundaries').style.zIndex = 307;


</script>

<script type=text/javascript id="extraScript">
</script>

</body>

</html>
